= Camel-Quarkus Demo

== How to Prepare the Demo

[source,shell]
----
# Start a cluster, for instance:
crc start -b crc-linux-1.8.0-amd64/crc_libvirt_4.3.8.crcbundle

# Login
oc login -u kubeadmin -p <PASSWORD> https://api.crc.testing:6443

# Set java version if needed
sdk use java 11.0.7.hs-adpt

# Clone the git demo project locally
cd camel-quarkus-demo
git clone https://github.com/aldettinger/camel-quarkus-hellos.git camel-quarkus-hellos

# Deploy hellos project to the crc cluster
cd camel-hellos
mvnu clean package -Dquarkus.kubernetes.deploy=true

# Check that the jvm mode pod is working
curl -X PUT -d '{ "room" : { "temperature" : 35}}' http://hello-camel-quarkus-jvm-mode-default.apps-crc.testing/hello-camel-quarkus-jvm-mode --resolve hello-camel-quarkus-jvm-mode-default.apps-crc.testing:$(crc ip)
curl http://hello-camel-quarkus-jvm-mode-default.apps-crc.testing/hello-camel-quarkus-jvm-mode --resolve hello-camel-quarkus-jvm-mode-default.apps-crc.testing:$(crc ip)

# Check that the native mode pod is working
# ERROR logs from pdfont are excluded as the log level is set to FATAL
curl -X PUT -d '{ "room" : { "temperature" : 20}}' http://hello-camel-quarkus-native-mode-default.apps-crc.testing/hello-camel-quarkus-native-mode --resolve hello-camel-quarkus-native-mode-default.apps-crc.testing:$(crc ip)
curl http://hello-camel-quarkus-native-mode-default.apps-crc.testing/hello-camel-quarkus-native-mode --resolve hello-camel-quarkus-native-mode-default.apps-crc.testing:$(crc ip)

# Delete the my-quarkus-demo-project if any
cd ..
rm -fr my-quarkus-project

Open terminator
Split window vertically #And in both terminal do:
cd ~/dev/demos/camel-quarkus-demo/
sdk use java 11.0.7.hs-adpt
----

== How to Run the Demo

[source,shell]
----
mvnu io.quarkus:quarkus-maven-plugin:1.5.0.Final:create
# Keep all default values

# Show the developer joy of quarkus dev mode
cd my-quarkus-project
mvnu quarkus:add-extensions -Dextensions=platform-http,jsonpath

# Import in eclipse: ~/dev/demos/camel-quarkus-demo/my-quarkus-project

Create MyRouteBuilder class:
public class MyRouteBuilder extends RouteBuilder {
    @Override
    public void configure() {
        from("platform-http:/hello").setBody(simple("Hello From Camel Quarkus !"));
    }
}

# Show the dev mode, update message and curl again
mvnu quarkus:dev

# Get the first body, change, and show update in the blink of an eye
curl http://localhost:8080/hello

# Add MyRouteBuilderTest:
import static io.restassured.RestAssured.given;

@QuarkusTest
public class MyRouteBuilderTest {
    @Test
    void getHelloShouldReturnHttp200(){
        given().when().get("/hello").then().statusCode(200);
    }
}

# Display the size of the runner + lib + 
du -chs target/my-quarkus-project-1.0-SNAPSHOT-runner.jar target/lib ${JAVA_HOME}

# Show the jvm mode from the command line
java -jar target/my-quarkus-project-1.0-SNAPSHOT-runner.jar

# Notice the quarkus boot time
# Define Resident Set Size (everything in RAM, shared library + stack + heap) and display usage in KiB
ps -o rss,cmd $(pgrep -f quarkus)

# Proves that it run but ONLY after having checked initial memory
curl http://localhost:8080/hello

# Then show native mode
# 2m30s Speach, it takes time so explain
# Recap JVM mode optimization (closed world + build time configuration)... TODO
# Native mode, graalvm, static code analysis, remove jit, execute static initializer, take heap snapshot... TODO
mvnu package -P native

# Show size first
du -chs target/my-quarkus-project-1.0-SNAPSHOT-runner*
# Then boot time
target/my-quarkus-project-1.0-SNAPSHOT-runner
# Then rss time
ps -o rss,cmd $(pgrep -f quarkus)
# And finally show it working
curl http://localhost:8080/hello

# TODO: Integrate a bit of jsonpath logic here and modify apps used by compare.sh
curl -X put -d '{ "room" : { "temperature" : 35}}' http://localhost:8080/hello
# Open http://localhost:8080/hello from web browser

# Then run the demo comparing camel-hellos project, e.g a summary like
# Implement standalone, and perharps spring boot
						boot	rss		size
 standalone			1s		1Mo		1Mo
 spring-boot			2s		2Mo		2Mo
 quarkus-jvm-mode		3s		3Mo		3Mo
 quarkus-native-mode	4s		4Mo		4Mo
camel-hellos/compare.sh

# Then show the resulting densification in a crc cluster with quotas mem ? cpu ? (ideally all hellos project but could be only jvm vs native)
# Launch some requests to scale pods, we would expect native to exhibit a better densification
At first, it's possible to set replicas = 20 and show the time it takes in OpenShift DeploymentConfig view

Raw notes for demo/improvements:
Interest of native mode:
JIT vs AOT => faster startup since code is already pre-compiled into efficient machine code
No need to include infrastructure to load and optimize code at run time => less memory
static analysis to embed what's used from the JDK, 3rd party libs and JVM code
Tool "hey" to push a burden like "hey url"
vscode to have auto completion ?
init project from quarkus.io ?
compare.sh compare disk/boot/rss before the first request, so do the same during the demo
Show quarkus live reload ? (update the dev and show result directly in the cluster)
Does quarkus really improve disk size in jvm mode only ? integrate an unused class and check size for instance ?
Does quarkus really improve memory size in jvm mode only ? how ?
Finish the demo explaining how could help with camel-quarkus project

When I boot offline, then start crc, I get the issue below:
ERRO Failed to query DNS from host: lookup api.crc.testing on [::1]:53: read udp [::1]:36955->[::1]:53: read: connection refused
Maybe an app listening on port 53 ? Only when started without network ?
Then, I replug the network, start vpn and I can start crc again
----
